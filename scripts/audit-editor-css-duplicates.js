const fs = require('fs');
const path = require('path');

const files = [
	'src/css/editor.scss',
	'src/editor/library/editor.scss',
	'src/components/toolbar/editor.scss',
];

const readFile = filePath =>
	fs.readFileSync(path.resolve(__dirname, '..', filePath), 'utf8');

const stripComments = input =>
	input
		.replace(/\/\*[\s\S]*?\*\//g, '')
		.replace(/\/\/.*$/gm, '');

const stripNestedBlocks = input => {
	let depth = 0;
	let result = '';
	for (let i = 0; i < input.length; i += 1) {
		const char = input[i];
		if (char === '{') {
			depth += 1;
			continue;
		}
		if (char === '}') {
			depth = Math.max(depth - 1, 0);
			continue;
		}
		if (depth === 0) {
			result += char;
		}
	}
	return result;
};

const normalizeDeclarations = declarations =>
	stripNestedBlocks(declarations)
		.split(';')
		.map(line => line.trim())
		.filter(line => line && line.includes(':'))
		.sort()
		.join(';');

const buildSelectorContext = (stack, selector) => {
	const prefix = stack
		.filter(entry => entry.type === 'at')
		.map(entry => entry.label.trim())
		.join(' ');

	const selectorPrefix = stack
		.filter(entry => entry.type === 'selector')
		.map(entry => entry.label.trim())
		.join(' ');

	const combinedSelector = [selectorPrefix, selector.trim()]
		.filter(Boolean)
		.join(' ')
		.replace(/\s+/g, ' ')
		.trim();

	return [prefix, combinedSelector].filter(Boolean).join(' ');
};

const isLikelySelector = label =>
	label && !label.includes('$') && !label.includes(';');

const extractBlocks = (rawContent, filePath) => {
	const content = stripComments(rawContent);
	const blocks = [];
	const stack = [];
	let token = '';

	for (let i = 0; i < content.length; i += 1) {
		const char = content[i];

		if (char === '{') {
			const label = token.trim();
			if (label) {
				const type = label.startsWith('@') ? 'at' : 'selector';
				if (type === 'at' || isLikelySelector(label)) {
					stack.push({ type, label, declarations: '' });
				}
			}
			token = '';
			continue;
		}

		if (char === '}') {
			const closed = stack.pop();
			if (closed?.type === 'selector') {
				const normalizedDeclarations = normalizeDeclarations(
					closed.declarations
				);
				if (normalizedDeclarations) {
					blocks.push({
						selector: buildSelectorContext(stack, closed.label),
						declarations: normalizedDeclarations,
						filePath,
					});
				}
			}
			token = '';
			continue;
		}

		if (char === ';' && stack.length) {
			token = '';
		}

		token += char;

		const current = stack[stack.length - 1];
		if (current?.type === 'selector') {
			current.declarations += char;
		}
	}

	return blocks;
};

const blocks = files.flatMap(filePath =>
	extractBlocks(readFile(filePath), filePath)
);

const normalized = new Map();

for (const block of blocks) {
	const entry = normalized.get(block.declarations) || [];
	entry.push(block);
	normalized.set(block.declarations, entry);
}

const duplicates = [...normalized.entries()]
	.map(([declarations, matches]) => ({ declarations, matches }))
	.filter(({ matches }) => matches.length > 1)
	.sort((a, b) => b.matches.length - a.matches.length);

const output = [
	'# Editor SCSS Duplicate Declarations Audit',
	'',
	'Generated by `scripts/audit-editor-css-duplicates.js`.',
	'',
	'## Scope',
	files.map(file => `- ${file}`).join('\n'),
	'',
	'## Notes',
	'- This audit inspects selector blocks and normalizes declaration order.',
	'- Nested selector blocks are stripped before normalization.',
	'- At-rule contexts (e.g., media queries) are prefixed to selectors for clarity.',
	'',
	`## Duplicate Declaration Groups (${duplicates.length})`,
];

for (const [index, group] of duplicates.entries()) {
	output.push('', `### Group ${index + 1} (${group.matches.length} matches)`, '');
	output.push('**Declarations**', '');
	output.push('```scss', group.declarations, '```', '');
	output.push('**Selectors**', '');
	for (const match of group.matches) {
		output.push(`- ${match.filePath}: \
\t\t\
\t\t\
\t\t\`${match.selector}\``);
	}
}

fs.writeFileSync(
	path.resolve(__dirname, '..', 'reports/editor-css-duplicates.md'),
	output.join('\n'),
	'utf8'
);

console.log(`Wrote ${duplicates.length} groups to reports/editor-css-duplicates.md`);
